## 用户登录认证

### 1、用户认证与授权

在一个系统中，通常会对用户的身份进行验证，判断用户是否有资格访问该系统下的访问路径、操作权限、资源资格等等。就比如在一个在线学习网络教学系统，用户通过在线学习页面点播视频进行学习。如何去记录学生的学习过程呢？要想掌握学生的学习情况就需要知道用户的身份信息，记录哪个用户在什么时间学习什么课程；如果用户要购买课程也需要知道用户的身份信息。所以，去管理学生的学习过程最基本的要实现用户的身份认证。

#### 1.1 什么是用户身份认证？

用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证表现形式有：用户名密码登录，第三方登录等方式。

#### 1.2 什么是用户授权？

用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。



### 2、单点登录

单点登录（Single Sign On）简称SSO，是在多个应用系统中，**用户只需要登录一次就可以访问所有相互信任的应用系统**。它包括可以将这次主要的登录映射到其他应用中用于同一个用户的登录的机制。它是目前比较流行的企业业务整合的解决方案之一。



传统登录方案

![img](https://qqadapt.qpic.cn/txdocpic/0/14dd5176f0343e35afab4648acebcd10/0)



分布式系统登录方案

![img](https://qqadapt.qpic.cn/txdocpic/0/031b35184efe7acf4dfb710519f0e6b5/0)



单点登录的特点是：
1、认证系统为独立的系统。
2、各子系统通过Http或其它协议与认证系统通信，完成用户认证。
3、用户身份信息存储在Redis集群。
Java中有很多用户认证的框架都可以实现单点登录：
1、Apache Shiro.
2、CAS
3、Spring security CAS



### 3、第三方认证

#### 3.1 什么是第三方认证（跨平台认证）？

当需要访问第三方系统的资源时需要首先通过第三方系统的认证（例如：微信认证），由第三方系统对用户认证通
过，并授权资源的访问权限。

#### 3.2 Oauth2认证流程

第三方认证技术方案最主要是解决认证协议的通用标准 问题，因为要实现 跨系统认证，各系统之间要遵循一定的
接口协议。
OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。同时，任何第三方都可以使用OAUTH认
证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。业界提供了OAUTH的多种实
现如PHP、JavaScript，Java，Ruby等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。互联网
很多服务如Open API，很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明
OAUTH标准逐渐成为开放资源授权的标准。
Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。
参考：https://baike.baidu.com/item/oAuth/7153134?fr=aladdin
Oauth协议：https://tools.ietf.org/html/rfc6749

#### 3.3第三方登录的流程分析

1、客户端请求第三方授权用户进入登录页面，点击微信的图标以微信账号登录系统，用户是自己在微信里信息的资源拥有者。

2、资源拥有者同意给客户端授权资源拥有者扫描二维码表示资源拥有者同意给客户端授权，微信会对资源拥有者的身份进行验证， 验证通过后，微信会询问用户是否给授权访问自己的微信数据，用户点击“确认登录”表示同意授权，微信认证服务器会颁发一个授权码，并重定向到系统网站。

3、客户端获取到授权码，请求认证服务器申请令牌此过程用户看不到，客户端应用程序请求认证服务器，请求携带授权码。

4、认证服务器向客户端响应令认证服务器验证了客户端请求的授权码，如果合法则给客户端颁发令牌，令牌是客户端访问资源的通行证。此交互过程用户看不到，当客户端拿到令牌后，用户在网站中看到已经登录成功。

5、客户端请求资源服务器的资源客户端携带令牌访问资源服务器的资源。网站携带令牌请求访问微信服务器获取用户的基本信息。

6、资源服务器返回受保护资源资源服务器校验令牌的合法性，如果合法则向用户响应资源信息内容。

>  注意：资源服务器和认证服务器可以是一个服务也可以分开的服务，如果是分开的服务资源服务器通常要请求认证服务器来校验令牌的合法性。



#### 3.4 Oauth2包括以下角色：

1、客户端
本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：学成在线Android客户端、学成在
线Web客户端（浏览器端）、微信客户端等。
2、资源拥有者
通常为用户，也可以是应用程序，即该资源的拥有者。
3、授权服务器（也称认证服务器）
用来对资源拥有的身份进行认证、对访问资源进行授权。客户端要想访问资源需要通过认证服务器由资源拥有者授
权后方可访问。
4、资源服务器
存储资源的服务器，比如，学成网用户管理服务器存储了学成网的用户信息，学成网学习服务器存储了学生的学习
信息，微信的资源服务存储了微信的用户信息等。客户端最终访问资源服务器获取资源信息。

3.3 Oauth2授权码模式
3.3.1 Oauth2授权模式
Oauth2有以下授权模式：
授权码模式（Authorization Code） 隐式授权模式（Implicit） 密码模式（Resource Owner Password
Credentials） 客户端模式（Client Credentials）
其中授权码模式和密码模式应用较多，本小节介绍授权码模式。
3.3.2 授权码授权流程
上边例举的黑马程序员网站使用微信认证的过程就是授权码模式，流程如下：
1、客户端请求第三方授权 2、用户(资源拥有者)同意给客户端授权 3、客户端获取到授权码，请求认证服务器申请
令牌 4、认证服务器向客户端响应令牌 5、客户端请求资源服务器的资源，资源服务校验令牌合法性，完成授权
6、资源服务器返回受保护资源
3.3.2 申请授权码
请求认证服务获取授权码：
Get请求：

localhost:40400/auth/oauth/authorize?
client_id=XcWebApp&response_type=code&scop=app&redirect_uri=http://localhost

参数列表如下：
client_id：客户端id，和授权配置类中设置的客户端id一致。
response_type：授权码模式固定为code
scop：客户端范围，和授权配置类中设置的scop一致。
redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）。

3.3.3 申请令牌拿到授权码后，申请令牌。Post请求：http://localhost:40400/auth/oauth/token参数如下：grant_type：授权类型，填写authorization_code，表示授权码模式code：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请。redirect_uri：申请授权码时的跳转url，一定和申请授权码时用的redirect_uri一致。此链接需要使用 http Basic认证。什么是http Basic认证？http协议定义的一种认证方式，将客户端id和客户端密码按照“客户端ID:客户端密码”的格式拼接，并用base64编码，放在header中请求服务端，一个例子：Authorization：Basic WGNXZWJBcHA6WGNXZWJBcHA=WGNXZWJBcHA6WGNXZWJBcHA= 是用户名:密码的base64编码。
认证失败服务端返回 401 Unauthorized
以上测试使用postman完成：
http basic认证：

access_token：访问令牌，携带此令牌访问资源token_type：有MAC Token与Bearer Token两种类型，两种的校验算法不同，RFC 6750建议Oauth2采用 BearerToken（http://www.rfcreader.com/#rfc6750）。refresh_token：刷新令牌，使用此令牌可以延长访问令牌的过期时间。expires_in：过期时间，单位为秒。scope：范围，与定义的客户端范围一致。

