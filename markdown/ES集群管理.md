## 高并发高可用-ElasticSearch

### ES是如何解决高并发

ES是一个分布式全文检索框架，隐藏了复杂的处理机制，核心内容 分片机制、集群发现、分片负载均衡请求路由。

 

### ES基本概念名词

### Cluster

 

代表一个集群，集群中有多个节点，其中有一个为主节点，这个主节点是可以通过选举产生的，主从节点是对于集群内部来说的。es的一个概念就是去中心化，字面上理解就是无中心节点，这是对于集群外部来说的，因为从外部来看es集群，在逻辑上是个整体，你与任何一个节点的通信和与整个es集群通信是等价的。

 

### Shards

代表索引分片，es可以把一个完整的索引分成多个分片，这样的好处是可以把一个大的索引拆分成多个，分布到不同的节点上。构成分布式搜索。分片的数量只能在索引创建前指定，并且索引创建后不能更改。

 

### replicas

代表索引副本，es可以设置多个索引的副本，副本的作用一是提高系统的容错性，当某个节点某个分片损坏或丢失时可以从副本中恢复。二是提高es的查询效率，es会自动对搜索请求进行负载均衡。

 

### Recovery

代表数据恢复或叫数据重新分布，es在有节点加入或退出时会根据机器的负载对索引分片进行重新分配，挂掉的节点重新启动时也会进行数据恢复。

 

 

## ES为什么要实现集群

ES集群中索引可能由多个分片构成，并且每个分片可以拥有多个副本。通过将一个单独的索引分为多个分片，我们可以处理不能在一个单一的服务器上面运行的大型索引，简单的说就是索引的大小过大，导致效率问题。不能运行的原因可能是内存也可能是存储。由于每个分片可以有多个副本，通过将副本分配到多个服务器，可以提高查询的负载能力。

 

 

 

 

 

 

GET _cat/health

 

 

ES集群核心原理分析:

 数据存储。

1、每个索引会被分成多个分片shards进行存储，默认创建索引是分配5个分片进行存储。

每个分片都会分布式部署在多个不同的节点上进行部署，该分片成为primary shards。

   **注意：索引的主分片primary shards定义好后，后面不能做修改。**

 

2、为了实现高可用数据的高可用，主分片可以有对应的备分片replics shards，replic shards分片承载了负责容错、以及请求的负载均衡。

  

注意: 每一个主分片为了实现高可用，都会有自己对应的备分片，主分片对应的备分片不能存放同一台服务器上。，主分片primary shards可以和其他replics shards存放在同一个node节点上。





## ES集群环境搭建

 

### 服务器环境

准备三台服务器集群

 

| **服务器名称** | **IP****地址**      |
| -------------- | ------------------- |
| **node-1**     | **192.168.212.182** |
| **node-2**     | **192.168.212.183** |
| **node-3**     | **192.168.212.184** |

 

 

### 服务集群配置



关闭防火墙 systemctl stop firewalld.service

默认底层开启9300 集群

### 验证集群效果

<http://192.168.212.185:9200/_cat/nodes?pretty>

 

 

注意克隆data文件会导致数据不同步

报该错误解决办法 

failed to send join request to master

因为克隆导致

data

文件也克隆呢，直接清除每台服务器

data

文件。